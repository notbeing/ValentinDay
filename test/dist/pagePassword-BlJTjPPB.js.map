{"version":3,"mappings":";0WAwBA,IAAIA,EAEJ,MAAMC,EAAe,IAAoB,CACjCC,QAAO,IAAIC,EAAU,CACzB,UAAW,gBACX,iBAAkB,GAClB,aAAc,uBACd,gBAAiB,0BAClB,EAEKC,EAAUC,EAAO,+BAA+B,EAChDC,EAAc,IAAIC,EAAK,YAAY,CAAC,IAAK,aAAa,EAEpDH,EAAA,OAAOE,EAAY,OAAO,EAE5B,MAAAE,EAAqB,IAAIC,EAAmB,CAChD,MAAO,gBACP,KAAM,WACP,EAEDT,EAAgBQ,EAAmB,MAEnCN,EAAK,aAAa,OAAOM,EAAmB,UAAWJ,CAAO,EAE1D,IAAAM,EAEJ,MAAMC,EAAW,KAEXD,IACiBA,EAAA,OAAO,YAAYC,EAAU,GAAI,GAGtCC,EAAU,SAAS,gBAAgB,SAAS,EAAE,KAAMC,GAAW,CACrEC,EAAAD,EAELC,EAAM,KACPC,EAAeP,EAAmB,MAAOQ,EAAWC,EAAcH,EAAM,IAAI,CAAC,CAAC,EAE9EN,EAAmB,SAAS,CAC9B,CACD,GAGC,IAAAM,EAEE,MAAAI,EAAYC,GAAc,CAK3B,GAJAA,GACDC,EAAYD,CAAC,EAGZ,CAACnB,EAAc,MAAM,OAAQ,CAChBA,EAAA,UAAU,IAAI,OAAO,EACnC,MACF,CAEA,MAAMqB,EAASC,EAAiB,CAACtB,EAAeI,CAAO,EAAG,EAAI,EACxDmB,EAAQvB,EAAc,MAE5BM,EAAY,OAAO,CAAC,IAAK,YAAa,GAChC,MAAAkB,EAAYC,EAAarB,CAAO,EAEtCI,EAAmB,iBAAiB,GAAK,KAAK,OAAQ,GACtDA,EAAmB,iBAAiBe,CAAK,EAE/BX,EAAA,SAAS,gBAAgB,MAAMW,EAAOT,CAAK,EAAE,KAAMY,GAAa,CAGxE,OAAOA,EAAS,EAAG,CACjB,IAAK,qBACH,cAAchB,CAAgB,EAC9BiB,EAAA,WAAO,sBAAU,8CAAE,KAAMC,GAAM,CAC7BA,EAAE,QAAQ,OAAM,CACjB,EACEC,GAAQA,EAAO,OAAO,EACzB,MACF,QACEzB,EAAQ,gBAAgB,UAAU,EAClCE,EAAY,OAAO,CAAC,IAAKoB,EAAS,CAAS,GAC3CF,EAAU,OAAO,EACjB,KACJ,EACD,EAAE,MAAOM,GAAa,CAIrB,OAHOT,IACYb,EAAA,MAAM,UAAU,IAAI,OAAO,EAEvCsB,EAAI,KAAM,CACf,QAEExB,EAAY,OAAO,CAAC,IAAK,uBAAwB,GACjDN,EAAc,OAAO,EACrB,KACJ,CAEAwB,EAAU,OAAO,EAERb,GAAA,CACV,GAGHoB,EAAiB3B,EAASc,CAAQ,EAEpBlB,EAAA,iBAAiB,WAAY,SAAemB,EAAG,CAIxD,GAHE,eAAU,OAAO,OAAO,EAC7Bb,EAAY,OAAO,CAAC,IAAK,YAAa,GAEnCa,EAAE,MAAQ,QACX,OAAOD,EAAS,CAClB,CACD,EAEK,MAAAc,EAAOC,EAAW,SAAW,IAAM,IACnCJ,EAAS,IAAIK,EAAe1B,EAAoBwB,CAAI,EAC1D9B,SAAK,SAAS,OAAO2B,EAAO,SAAS,EAC9B,QAAQ,IAAI,CACjBA,EAAO,KAAK,EACZlB,EAAS,EACV,CACH,EAEMT,EAAO,IAAIiC,EAAK,gBAAiB,GAAMlC,EAAc,KAAM,IAAM,CAErED,EAAc,MAAM,EAGpBY,EAAU,SAAS,gBAAgB,YAAY,YAAa,CAAC,EAAG,oBAAoB,CACtF,CAAC","names":["passwordInput","onFirstMount","page","LoginPage","btnNext","Button","btnNextI18n","I18n","passwordInputField","PasswordInputField","getStateInterval","getState","rootScope","_state","state","replaceContent","htmlToSpan","wrapEmojiText","onSubmit","e","cancelEvent","toggle","toggleDisability","value","preloader","putPreloader","response","__vitePreload","m","monkey","err","attachClickEvent","size","mediaSizes","PasswordMonkey","Page"],"ignoreList":[],"sources":["../src/pages/pagePassword.ts"],"sourcesContent":["/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {putPreloader} from '../components/putPreloader';\r\nimport mediaSizes from '../helpers/mediaSizes';\r\nimport {AccountPassword} from '../layer';\r\nimport Page from './page';\r\nimport Button from '../components/button';\r\nimport PasswordInputField from '../components/passwordInputField';\r\nimport PasswordMonkey from '../components/monkeys/password';\r\nimport I18n from '../lib/langPack';\r\nimport LoginPage from './loginPage';\r\nimport cancelEvent from '../helpers/dom/cancelEvent';\r\nimport {attachClickEvent} from '../helpers/dom/clickEvent';\r\nimport htmlToSpan from '../helpers/dom/htmlToSpan';\r\nimport replaceContent from '../helpers/dom/replaceContent';\r\nimport toggleDisability from '../helpers/dom/toggleDisability';\r\nimport wrapEmojiText from '../lib/richTextProcessor/wrapEmojiText';\r\nimport rootScope from '../lib/rootScope';\r\n\r\nconst TEST = false;\r\nlet passwordInput: HTMLInputElement;\r\n\r\nconst onFirstMount = (): Promise<any> => {\r\n  const page = new LoginPage({\r\n    className: 'page-password',\r\n    withInputWrapper: true,\r\n    titleLangKey: 'Login.Password.Title',\r\n    subtitleLangKey: 'Login.Password.Subtitle'\r\n  });\r\n\r\n  const btnNext = Button('btn-primary btn-color-primary');\r\n  const btnNextI18n = new I18n.IntlElement({key: 'Login.Next'});\r\n\r\n  btnNext.append(btnNextI18n.element);\r\n\r\n  const passwordInputField = new PasswordInputField({\r\n    label: 'LoginPassword',\r\n    name: 'password'\r\n  });\r\n\r\n  passwordInput = passwordInputField.input as HTMLInputElement;\r\n\r\n  page.inputWrapper.append(passwordInputField.container, btnNext);\r\n\r\n  let getStateInterval: number;\r\n\r\n  const getState = () => {\r\n    // * just to check session relevance\r\n    if(!getStateInterval) {\r\n      getStateInterval = window.setInterval(getState, 10e3);\r\n    }\r\n\r\n    return !TEST && rootScope.managers.passwordManager.getState().then((_state) => {\r\n      state = _state;\r\n\r\n      if(state.hint) {\r\n        replaceContent(passwordInputField.label, htmlToSpan(wrapEmojiText(state.hint)));\r\n      } else {\r\n        passwordInputField.setLabel();\r\n      }\r\n    });\r\n  };\r\n\r\n  let state: AccountPassword;\r\n\r\n  const onSubmit = (e?: Event) => {\r\n    if(e) {\r\n      cancelEvent(e);\r\n    }\r\n\r\n    if(!passwordInput.value.length) {\r\n      passwordInput.classList.add('error');\r\n      return;\r\n    }\r\n\r\n    const toggle = toggleDisability([passwordInput, btnNext], true);\r\n    const value = passwordInput.value;\r\n\r\n    btnNextI18n.update({key: 'PleaseWait'});\r\n    const preloader = putPreloader(btnNext);\r\n\r\n    passwordInputField.setValueSilently('' + Math.random()); // prevent saving suggestion\r\n    passwordInputField.setValueSilently(value); // prevent saving suggestion\r\n\r\n    rootScope.managers.passwordManager.check(value, state).then((response) => {\r\n      // console.log('passwordManager response:', response);\r\n\r\n      switch(response._) {\r\n        case 'auth.authorization':\r\n          clearInterval(getStateInterval);\r\n          import('./pageIm').then((m) => {\r\n            m.default.mount();\r\n          });\r\n          if(monkey) monkey.remove();\r\n          break;\r\n        default:\r\n          btnNext.removeAttribute('disabled');\r\n          btnNextI18n.update({key: response._ as any});\r\n          preloader.remove();\r\n          break;\r\n      }\r\n    }).catch((err: any) => {\r\n      toggle();\r\n      passwordInputField.input.classList.add('error');\r\n\r\n      switch(err.type) {\r\n        default:\r\n          // btnNext.innerText = err.type;\r\n          btnNextI18n.update({key: 'PASSWORD_HASH_INVALID'});\r\n          passwordInput.select();\r\n          break;\r\n      }\r\n\r\n      preloader.remove();\r\n\r\n      getState();\r\n    });\r\n  };\r\n\r\n  attachClickEvent(btnNext, onSubmit);\r\n\r\n  passwordInput.addEventListener('keypress', function(this, e) {\r\n    this.classList.remove('error');\r\n    btnNextI18n.update({key: 'Login.Next'});\r\n\r\n    if(e.key === 'Enter') {\r\n      return onSubmit();\r\n    }\r\n  });\r\n\r\n  const size = mediaSizes.isMobile ? 100 : 166;\r\n  const monkey = new PasswordMonkey(passwordInputField, size);\r\n  page.imageDiv.append(monkey.container);\r\n  return Promise.all([\r\n    monkey.load(),\r\n    getState()\r\n  ]);\r\n};\r\n\r\nconst page = new Page('page-password', true, onFirstMount, null, () => {\r\n  // if(!isAppleMobile) {\r\n  passwordInput.focus();\r\n  // }\r\n\r\n  rootScope.managers.appStateManager.pushToState('authState', {_: 'authStatePassword'});\r\n});\r\n\r\nexport default page;\r\n"],"file":"pagePassword-BlJTjPPB.js"}